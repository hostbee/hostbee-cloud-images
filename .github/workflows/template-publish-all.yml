name: publish-all

on:
  workflow_call:
    inputs:
      CN_FLAG:
        required: true
        type: boolean
    MINIO_ENDPOINT:
      required: true
      type: string
      WORKFLOW_REF:
        required: true
        type: string

jobs:
  get-stamp:
    runs-on: [self-hosted]
    outputs:
      STAMP: ${{ steps.get-stamp.outputs.STAMP }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Always use the build from local Minio
      - name: Get Stamp
        id: get-stamp
        env:
          CN_FLAG: ${{ inputs.CN_FLAG }}
          MINIO_ENDPOINT: ${{ inputs.MINIO_ENDPOINT }}
        working-directory: ./build_scripts
        shell: bash
        run: ./get-stamp.sh

      - name: Sending Feishu Message
        uses: hostbee/feishu@main
        env:
          FEISHU_CUSTOMERBOT_WEBHOOK: ${{ secrets.FEISHU_CUSTOMERBOT_WEBHOOK }}
          FEISHU_CUSTOMERBOT_SECRET: ${{ secrets.FEISHU_CUSTOMERBOT_SECRET }}
          MSGTYPE: interactive
          TITLE: "🚀 Cloud Images Build Start"
          CONTENT: |
            > Ref: ${{ github.ref }}
            > Commit: ${{ github.sha }}
            > Build ID: ${{ steps.get-stamp.outputs.STAMP }}
            > CN: ${{ inputs.CN_FLAG }}
            > Log: https://github.com/hostbee/hostbee-cloud-images/actions/runs/${{ github.run_id }}

  get-bucket:
    runs-on: [self-hosted]
    outputs:
      BUCKET: ${{ steps.get-bucket.outputs.BUCKET }}
    steps:
      - name: Get Bucket
        id: get-bucket
        run: |
          if [ "${{ inputs.CN_FLAG }}" = "true" ]; then
            echo "BUCKET=hostbee-cloud-images-cn" >> $GITHUB_OUTPUT
          else
            echo "BUCKET=hostbee-cloud-images" >> $GITHUB_OUTPUT
          fi

  publish-batch:
    needs: [get-stamp, get-bucket]
    uses: ./.github/workflows/template-publish.yml
    strategy:
      max-parallel: 3
      matrix:
        TEMPLATE:
          - almalinux/8.pkr.hcl
          - almalinux/9.pkr.hcl
          - debian/11.pkr.hcl
          - debian/12.pkr.hcl
          - rocky/8.pkr.hcl
          - rocky/9.pkr.hcl
          - ubuntu/20.pkr.hcl
          - ubuntu/22.pkr.hcl
          - ubuntu/24.pkr.hcl
    with:
      TEMPLATE: ${{ matrix.TEMPLATE }}
      CN_FLAG: ${{ inputs.CN_FLAG }}
      BUCKET: ${{ needs.get-bucket.outputs.BUCKET }}
      MINIO_DIR: weekly/${{ needs.get-stamp.outputs.STAMP }}
    secrets: inherit

  update-latest:
    environment: OSS_KEYS
    needs: [get-stamp, get-bucket, publish-batch]
    runs-on: [self-hosted]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup MinIO
        uses: ./.github/actions/setup-minio
        with:
          MINIO_ENDPOINT: ${{ vars.MINIO_ENDPOINT }}
          MINIO_ACCESS_KEY: ${{ secrets.MINIO_ACCESS_KEY }}
          MINIO_SECRET_KEY: ${{ secrets.MINIO_SECRET_KEY }}
          R2_ENDPOINT: ${{ vars.R2_ENDPOINT }}
          R2_ACCESS_KEY: ${{ secrets.R2_ACCESS_KEY }}
          R2_SECRET_KEY: ${{ secrets.R2_SECRET_KEY }}

      - name: Update Latest
        run: |
          echo "/weekly/${{ needs.get-stamp.outputs.STAMP }}" > "./LATEST_BUILD.txt"
          mc cp "./LATEST_BUILD.txt" "hostbee_minio/${{ needs.get-bucket.outputs.BUCKET }}/LATEST_BUILD.txt"
          mc cp "./LATEST_BUILD.txt" "hostbee_r2/${{ needs.get-bucket.outputs.BUCKET }}/LATEST_BUILD.txt"

      - name: Sending Feishu Message
        uses: hostbee/feishu@main
        env:
          FEISHU_CUSTOMERBOT_WEBHOOK: ${{ secrets.FEISHU_CUSTOMERBOT_WEBHOOK }}
          FEISHU_CUSTOMERBOT_SECRET: ${{ secrets.FEISHU_CUSTOMERBOT_SECRET }}
          MSGTYPE: interactive
          TITLE: "✅ Cloud Images Build Done"
          CONTENT: |
            > Ref: ${{ github.ref }}
            > Commit: ${{ github.sha }}
            > Build ID: ${{ needs.get-stamp.outputs.STAMP }}
            > CN: ${{ inputs.CN_FLAG }}
            > Log: https://github.com/hostbee/hostbee-cloud-images/actions/runs/${{ github.run_id }}

  message-on-fail:
    needs: [publish-batch]
    if: ${{ always() && (failure() || cancelled()) }}
    environment: OSS_KEYS
    runs-on: [self-hosted]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Sending Feishu Message
        uses: hostbee/feishu@main
        env:
          FEISHU_CUSTOMERBOT_WEBHOOK: ${{ secrets.FEISHU_CUSTOMERBOT_WEBHOOK }}
          FEISHU_CUSTOMERBOT_SECRET: ${{ secrets.FEISHU_CUSTOMERBOT_SECRET }}
          MSGTYPE: interactive
          TITLE: "❌ Cloud Images Build Failed"
          CONTENT: |
            > Ref: ${{ github.ref }}
            > Commit: ${{ github.sha }}
            > CN: ${{ inputs.CN_FLAG }}
            > Log: https://github.com/hostbee/hostbee-cloud-images/actions/runs/${{ github.run_id }}
